<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dollies App V3</title>
    <!-- Include Tailwind CSS for a clean, modern design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* New highlight animation for records */
        .highlight-record {
            animation: highlight-fade-blue 1s ease-in-out forwards;
        }
        .highlight-new-record {
            animation: highlight-fade-orange 1s ease-in-out forwards;
        }
        
        /* Keyframes for record highlight */
        @keyframes highlight-fade-blue {
            0% { background-color: transparent; box-shadow: none; }
            50% { background-color: rgba(228, 241, 255, 0.8); box-shadow: 0 0 10px 5px rgba(59, 130, 246, 0.5); }
            100% { background-color: transparent; box-shadow: none; }
        }
        @keyframes highlight-fade-orange {
            0% { background-color: transparent; box-shadow: none; }
            50% { background-color: rgba(255, 237, 213, 0.8); box-shadow: 0 0 10px 5px rgba(249, 115, 22, 0.5); }
            100% { background-color: transparent; box-shadow: none; }
        }

        /* New animation for the count number */
        .highlight-count-scale {
            animation: scale-up 1s ease-in-out forwards;
        }

        /* Keyframes for the count scale animation */
        @keyframes scale-up {
            0% { transform: scale(1); }
            50% { transform: scale(3); } /* Changed to scale(3) as requested */
            100% { transform: scale(1); }
        }

        /* Popover styles */
        #manual-add-popover {
            position: absolute;
            top: 60px; /* Position below the header */
            left: 1rem;
            right: 1rem;
            z-index: 50;
            display: none;
        }
        #manual-add-popover::before {
            content: '';
            position: absolute;
            top: -8px; /* Position outside the popover box */
            right: 1rem; /* Aligned with the button */
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }

        /* Screen navigation animations */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.3s ease-out;
            transform: translateX(100%);
            background-color: #f3f4f6; /* Set a default background for screens */
        }
        #screen-1 {
             background-color: white;
        }

        .screen.active {
            transform: translateX(0);
        }
        .screen.hidden-left {
            transform: translateX(-100%);
        }
        
        /* Fixed header and notification container */
        .fixed-header-container {
            position: sticky;
            top: 0;
            z-index: 20;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Notification box styles */
        #notification-box {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #E2E8F0; /* Subtle grey background */
            border-bottom: 1px solid #CBD5E1;
        }

        .scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
        }

        /* Custom scrollbar for WebKit browsers (Chrome, Safari, etc.) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280;
        }
        
        /* New overlay styles for the greyed-out background */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4); /* Semi-transparent grey */
            backdrop-filter: blur(2px); /* Optional blur effect */
            z-index: 40;
            display: none;
        }

        /* New styles for the update status panel */
        #update-status-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-top-left-radius: 1.5rem; /* 24px */
            border-top-right-radius: 1.5rem; /* 24px */
            box-shadow: 0 -10px 25px -5px rgba(0, 0, 0, 0.1), 0 -4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 50;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            padding: 1.5rem;
            padding-bottom: 2rem; /* Extra padding at bottom */
        }

        #update-status-panel.visible {
            transform: translateY(0);
        }
        
        /* Table styles */
        .table-container {
            height: 100%;
            overflow-y: auto;
        }
        #support-details-table thead th {
            position: sticky;
            top: 0;
            background-color: #e5e7eb; /* Light gray background for header */
            z-index: 10;
        }

        .text-darkslateblue { color: #483D8B; }
        .text-darkblue { color: #00008B; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main app container simulating a mobile screen -->
    <div id="app-container" class="relative w-full max-w-sm h-[700px] bg-white rounded-3xl shadow-2xl overflow-hidden">
        
        <!-- Global Overlay for popups on screen 1 -->
        <div id="global-overlay" class="overlay" onclick="closeOpenPopups()"></div>

        <!-- Popover for manual add -->
        <div id="manual-add-popover" class="bg-white rounded-xl shadow-lg left-6 right-6 z-50 flex flex-col">
            <!-- Popover content -->
            <div class="p-4 pb-0">
                <div class="space-y-4">
                    <div>
                        <label for="support-number" class="block text-sm font-medium text-gray-700">Support Number</label>
                        <input type="text" id="support-number-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-3 py-2" placeholder="Enter up to 18 digits" maxlength="18" pattern="\d*">
                        <p id="digit-counter" class="text-xs text-gray-500 text-right mt-1">0 / 18</p>
                    </div>
                </div>
            </div>
            <!-- Add button -->
            <div class="p-4">
                <button id="add-button" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm opacity-50 cursor-not-allowed" disabled onclick="addManually()">
                    Add
                </button>
            </div>
        </div>

        <!-- Screen 1: Main list screen -->
        <div id="screen-1" class="screen flex flex-col active">
            <!-- Fixed header and notification container -->
            <div class="fixed-header-container">
                <!-- App header -->
                <header class="bg-white pt-4 pb-4 px-4 flex items-center justify-between border-b border-gray-200">
                    <div>
                        <h1 class="text-xl font-bold text-gray-800 cursor-pointer" onclick="handleScanEvent()">Deliveries status</h1>
                        <p id="today-date" class="text-sm text-gray-500 mt-1"></p>
                    </div>
                    <button id="add-manually-button" class="bg-gray-300 text-gray-800 font-medium py-1 px-3 rounded-full shadow-md hover:bg-gray-400 transition-colors flex items-center text-sm" onclick="showManualAddPopover(event)">
                        <!-- Plus icon SVG -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Add Manually
                    </button>
                </header>

                <!-- Notification Box -->
                <div id="notification-box" class="px-4 py-2 flex flex-col items-start justify-center text-sm">
                    <p id="notification-number" class="font-semibold text-gray-700">-</p>
                    <p id="notification-message" class="text-xs text-gray-500 mt-0.5">Ready to scan or input a new delivery</p>
                </div>
            </div>

            <!-- List container -->
            <div class="scrollable-content mt-4 px-4 pr-1 pb-4">
                <ul id="delivery-list" class="space-y-4">
                    <!-- List items will be generated here with JavaScript -->
                </ul>
            </div>
        </div>

        <!-- Screen 2: Dolly details screen -->
        <div id="screen-2" class="screen flex flex-col">
            <!-- Dedicated overlay for this screen's panel -->
            <div id="screen-2-overlay" class="overlay" onclick="closeOpenPopups()"></div>

            <!-- Fixed header and details section -->
            <div class="fixed-header-container px-4">
                <!-- Back button -->
                <header class="py-4 flex items-center justify-between">
                    <h1 id="back-button" class="text-xl font-bold text-gray-800 cursor-pointer" onclick="goBack()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>                        
                    </h1>
                    <!-- Buttons container -->
                    <div class="flex items-center space-x-2">
                        <!-- Add to Stock button -->
                        <button id="add-to-stock-btn" class="hidden bg-gray-300 text-gray-800 font-medium py-1 px-3 rounded-full shadow-md hover:bg-gray-400 transition-colors flex items-center text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Add to Stock
                        </button>
                        <!-- Create SST button -->
                        <button id="create-sst-btn" class="hidden bg-gray-300 text-gray-800 font-medium py-1 px-3 rounded-full shadow-md hover:bg-gray-400 transition-colors flex items-center text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Create SST
                        </button>
                    </div>
                </header>

                <!-- Dolly details section (fixed) -->
                <div id="dolly-info-fixed" class="py-4 -mt-2">
                    <!-- Dolly details and KPIs will be rendered here by JS -->
                </div>
            </div>
            
            <!-- Scrollable content below the fixed header -->
            <div id="dolly-details-scrollable" class="scrollable-content p-4">
                <!-- The scrollable list of support numbers will be rendered here by JS -->
            </div>
            
            <!-- Update Status Panel -->
            <div id="update-status-panel">
                <div class="flex flex-col space-y-6">
                    <!-- Header -->
                    <div id="panel-header" class="flex justify-between items-center pb-4 border-b border-gray-200">
                        <div>
                            <p id="panel-support-number" class="font-bold text-lg text-gray-800"></p>
                            <p id="panel-support-subtitle" class="text-sm text-gray-500"></p>
                        </div>
                        <div class="text-right">
                            <p id="panel-support-status1" class="font-bold text-sm"></p>
                            <p id="panel-support-status2" class="text-xs text-gray-500"></p>
                        </div>
                    </div>

                    <!-- Update Status Section -->
                    <div id="update-status-section">
                        <h2 class="text-sm font-semibold text-gray-700 mb-3">Update status to</h2>
                        <div id="update-buttons-container" class="flex flex-col space-y-3">
                            <button id="btn-received-manual" onclick="updateItemStatus('Received (Manual)')" class="w-full bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-md shadow-sm hover:bg-gray-300 transition-colors text-sm flex justify-between items-center">
                                <span>Received (Manual)</span>
                                <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                            </button>
                            <button id="btn-received-no-support" onclick="updateItemStatus('Received (No support)')" class="w-full bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-md shadow-sm hover:bg-gray-300 transition-colors text-sm flex justify-between items-center">
                                <span>Received (No support)</span>
                                <span class="w-3 h-3 bg-orange-500 rounded-full"></span>
                            </button>
                            <button id="btn-not-delivered" onclick="updateItemStatus('Not delivered')" class="w-full bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-md shadow-sm hover:bg-gray-300 transition-colors text-sm flex justify-between items-center">
                                <span>Not delivered</span>
                                <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                            </button>
                            <button id="btn-not-scanned" onclick="updateItemStatus('Not scanned')" class="w-full bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-md shadow-sm hover:bg-gray-300 transition-colors text-sm flex justify-between items-center">
                                <span>Not scanned</span>
                                <span class="w-3 h-3 bg-gray-400 rounded-full"></span>
                            </button>
                        </div>
                    </div>

                    <!-- Other Actions Section -->
                    <div>
                        <h2 class="text-sm font-semibold text-gray-700 mb-3">Other actions</h2>
                        <button onclick="showSupportDetails()" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-md shadow-sm hover:bg-blue-700 transition-colors">Go to details</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen 3: Support details screen -->
        <div id="screen-3" class="screen flex flex-col">
             <!-- Fixed header -->
            <div class="fixed-header-container px-4">
                 <!-- Back button and title -->
                <header class="py-4 flex items-center">
                    <h1 id="back-button-screen3" class="text-xl font-bold text-gray-800 cursor-pointer" onclick="goBack()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>                        
                    </h1>
                    <span class="text-xl font-bold text-gray-800 ml-4">Support details</span>
                </header>
                <!-- Combined info section (fixed) -->
                <div id="support-info-fixed" class="py-4 -mt-2">
                    <!-- Content will be injected by JS -->
                </div>
            </div>
            <!-- Scrollable content -->
            <div id="support-details-scrollable" class="scrollable-content">
                 <div class="table-container">
                    <table id="support-details-table" class="w-full text-sm">
                        <thead class="text-xs text-gray-700 uppercase">
                            <tr>
                                <th scope="col" class="py-4 px-2 text-left w-2/3 cursor-pointer" onclick="sortDetailsTable('description')">
                                    <div class="flex items-center">
                                        Hope / Description
                                        <span id="sort-icon-description" class="ml-2"></span>
                                    </div>
                                </th>
                                <th scope="col" class="py-4 px-2 cursor-pointer" onclick="sortDetailsTable('qty')">
                                    <div class="flex items-center justify-center">
                                        Qty
                                        <span id="sort-icon-qty" class="ml-2"></span>
                                    </div>
                                </th>
                                <th scope="col" class="py-4 px-2 cursor-pointer" onclick="sortDetailsTable('colli')">
                                     <div class="flex items-center justify-end">
                                        #/Colli
                                        <span id="sort-icon-colli" class="ml-2"></span>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                           <!-- Table rows will be injected by JS -->
                        </tbody>
                    </table>
                 </div>
            </div>
        </div>
    </div>

    <script>
        // Test data for delivery notes, structured for the new UI
        const deliveryNotes = [
            {
                "id": 1,
                "delivery_note": "1901515212",
                "date_time": "10/08/2025 23:50",
                "data_warehouse": "Dist. Center 01",
                "received_count": 8,
                "total_count": 8,
                "status": "Treated",
                "not_scanned": 0,
                "not_delivered": 0
            },
            {
                "id": 2,
                "delivery_note": "5955959259",
                "date_time": "10/08/2025 19:37",
                "data_warehouse": "Dist. Center 02",
                "received_count": 5,
                "total_count": 12,
                "status": "Not treated",
                "not_scanned": 7,
                "not_delivered": 0
            },
            {
                "id": 3,
                "delivery_note": "1559141952",
                "date_time": "10/08/2025 13:15",
                "data_warehouse": "Dist. Center 03",
                "received_count": 3,
                "total_count": 5,
                "status": ["2 missing", "Not treated"],
                "not_scanned": 1,
                "not_delivered": 1
            },
            {
                "id": 4,
                "delivery_note": "1551159152",
                "date_time": "10/08/2025 19:16",
                "data_warehouse": "Dist. Center 32",
                "received_count": 7,
                "total_count": 11,
                "status": ["1 missing", "Not treated"],
                "not_scanned": 2,
                "not_delivered": 2
            },
            {
                "id": 5,
                "delivery_note": "293459130",
                "date_time": "10/07/2025 19:16",
                "data_warehouse": "Dist. Center 08",
                "received_count": 3,
                "total_count": 6,
                "status": ["1 missing", "Not treated"],
                "not_scanned": 1,
                "not_delivered": 2
            },
            {
                "id": 6,
                "delivery_note": "1901514877",
                "date_time": "10/07/2025 23:50",
                "data_warehouse": "Dist. Center 01",
                "received_count": 12,
                "total_count": 12,
                "status": "Treated",
                "not_scanned": 0,
                "not_delivered": 0
            },
            {
                "id": 7,
                "delivery_note": "1559145574",
                "date_time": "10/07/2025 13:15",
                "data_warehouse": "Dist. Center 32",
                "received_count": 2,
                "total_count": 4,
                "status": ["2 missing", "Not treated"],
                "not_scanned": 1,
                "not_delivered": 1
            },
            {
                "id": 8,
                "delivery_note": "5955951147",
                "date_time": "10/07/2025 19:37",
                "data_warehouse": "Dist. Center 09",
                "received_count": 1,
                "total_count": 9,
                "status": "Not treated",
                "not_scanned": 7,
                "not_delivered": 0
            }
        ];

        // --- App State ---
        let currentScreen = 1;
        let scanEventCounter = 0;
        let manualAddCounter = 0; 
        let activeDollyId = null; // Tracks the delivery note on screen 2
        let currentSelectedItem = null; // Tracks the support item selected in the panel
        let sortState = { key: 'description', order: 'asc' }; // For table sorting

        // Object to store pre-generated support numbers for each delivery note
        const supportNumbersByNote = {};
        const supportDetailsByNumber = {}; // NEW: Store for table data
        
        // --- Utility Functions ---
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function generateRandom18DigitNumber() {
            let result = '';
            for (let i = 0; i < 18; i++) {
                result += Math.floor(Math.random() * 10);
            }
            return result;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Screen Navigation ---
        function showScreen(screenNumber) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                if (parseInt(screen.id.replace('screen-', '')) === screenNumber) {
                    screen.classList.remove('hidden-left');
                    screen.classList.add('active');
                } else {
                    screen.classList.remove('active');
                    screen.classList.add('hidden-left');
                }
            });
            currentScreen = screenNumber;
        }

        function goBack() {
            if (currentScreen === 3) {
                showScreen(2);
                showDollyDetails(activeDollyId);
            } else if (currentScreen === 2) {
                activeDollyId = null; 
                closeOpenPopups();
                showScreen(1);
            }
        }
        
        // --- UI Update Functions ---
        function updateNotification(number, message) {
            const numberEl = document.getElementById('notification-number');
            const messageEl = document.getElementById('notification-message');
            const formattedNumber = number.replace(/(\d{4})/g, '$1 ').trim();
            numberEl.textContent = formattedNumber;
            messageEl.textContent = message;
        }

        function renderDeliveryList() {
            const listContainer = document.getElementById('delivery-list');
            listContainer.innerHTML = ''; 

            deliveryNotes.forEach(note => {
                let statusHtml = '';
                let verticalLineColor = '';
                let deliveryNoteHtml = note.delivery_note;

                if (Array.isArray(note.status) && note.status.some(s => s.includes('missing'))) {
                    verticalLineColor = 'bg-red-600';
                } else if (note.delivery_note === "No order") {
                    verticalLineColor = 'bg-orange-600';
                } else if (typeof note.status === 'string' && note.status === 'Treated') {
                    verticalLineColor = 'bg-green-600';
                } else {
                    verticalLineColor = 'bg-gray-300';
                }

                if (note.status === "Treated") {
                    statusHtml = `<p class="text-xs font-medium text-green-600">Treated</p>`;
                } else if (note.status === "Not treated" || (Array.isArray(note.status) && note.status.includes('Not treated'))) {
                    statusHtml = `<p class="text-xs font-medium text-gray-500">Not treated</p>`;
                }
                
                const li = document.createElement('li');
                li.id = `note-${note.id}`;
                li.innerHTML = `
                    <div onclick="showDollyDetails(${note.id})" class="flex bg-white rounded-xl shadow-md cursor-pointer hover:bg-gray-50 transition-colors">
                        <div class="w-2 rounded-l-xl ${verticalLineColor}"></div>
                        <div class="p-4 flex flex-col flex-grow">
                            <div class="flex justify-between items-center">
                                <p class="font-bold text-lg text-gray-900">${deliveryNoteHtml}</p>
                                <div class="flex items-baseline space-x-1">
                                    <span id="count-${note.id}" class="text-sm font-bold text-gray-700 transition-transform duration-200">${note.received_count}</span>
                                    <span class="text-sm text-gray-400">/</span>
                                    <span class="text-lg font-bold text-gray-900">${note.total_count}</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-xs text-gray-500">${note.date_time}</p>
                                ${statusHtml}
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-xs font-semibold text-gray-500">${note.data_warehouse}</p>
                            </div>
                        </div>
                    </div>
                `;
                listContainer.appendChild(li);
            });
        }
        
        // --- Event Handlers & Actions ---
        function handleScanEvent() {
            closeOpenPopups();
            scanEventCounter++;

            const randomSSCC = generateRandom18DigitNumber();
            let notificationMessage;
            let targetNote;

            if (scanEventCounter === 4) {
                updateNotification(randomSSCC, "Support not found");
                return;
            }
            
            if (scanEventCounter % 3 === 0) {
                notificationMessage = "Support identified for store but Delivery note not found";
            } else if (scanEventCounter % 2 !== 0) {
                targetNote = deliveryNotes[deliveryNotes.length - 1];
                notificationMessage = `Scanned. Delivery note: ${targetNote.delivery_note}`;
            } else {
                targetNote = deliveryNotes[1];
                notificationMessage = `Scanned. Delivery note: ${targetNote.delivery_note}`;
            }

            updateNotification(randomSSCC, notificationMessage);

            let newValue;
            let highlightClass;
            
            if (scanEventCounter % 3 === 0) {
                const now = new Date();
                const formattedDate = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${now.getFullYear()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                const newNote = {
                    "id": Date.now(), "delivery_note": "No order", "date_time": formattedDate, "data_warehouse": "Dist. Center 99",
                    "received_count": 1, "total_count": 1, "status": "Not treated", "not_scanned": null, "not_delivered": null
                };
                deliveryNotes.unshift(newNote);
                initializeSupportNumbers(newNote); 
                renderDeliveryList();
                targetNote = newNote;
                highlightClass = 'highlight-new-record';
            } else if (scanEventCounter % 2 !== 0) {
                targetNote = deliveryNotes[deliveryNotes.length - 1];
                newValue = 2;
                highlightClass = 'highlight-record';
            } else {
                targetNote = deliveryNotes[1];
                newValue = 6;
                highlightClass = 'highlight-record';
            }

            if (!targetNote) return;
            const targetRecordEl = document.getElementById(`note-${targetNote.id}`);
            if (!targetRecordEl) return;
            const recordDiv = targetRecordEl.querySelector('div');
            const countSpan = document.getElementById(`count-${targetNote.id}`);

            targetRecordEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => {
                if (recordDiv) { recordDiv.classList.add(highlightClass); }
                if (scanEventCounter % 3 === 0) {
                    setTimeout(() => { if (recordDiv) recordDiv.classList.remove(highlightClass); }, 1000);
                    return;
                }
                setTimeout(() => {
                    if (countSpan) {
                        countSpan.classList.add('highlight-count-scale');
                        setTimeout(() => {
                            targetNote.received_count = newValue;
                            countSpan.textContent = targetNote.received_count;
                            setTimeout(() => {
                                countSpan.classList.remove('highlight-count-scale');
                                renderDeliveryList();
                                if (recordDiv) recordDiv.classList.remove(highlightClass);
                            }, 500);
                        }, 200);
                    }
                }, 1000); 
            }, 500);
        }

        function showDollyDetails(dollyId) {
            showScreen(2);
            activeDollyId = dollyId; 
            const deliveryNote = deliveryNotes.find(note => note.id === dollyId);
            if (!deliveryNote) { console.error('Delivery note not found.'); return; }
            
            const addToStockBtn = document.getElementById('add-to-stock-btn');
            const createSSTBtn = document.getElementById('create-sst-btn');
            addToStockBtn.classList.add('hidden');
            createSSTBtn.classList.add('hidden');

            if (deliveryNote.data_warehouse === "Dist. Center 150") {
                addToStockBtn.classList.remove('hidden');
            } else {
                const supportNumbers = supportNumbersByNote[dollyId] || [];
                if (supportNumbers.some(item => item.status1 === "Not delivered" || (item.status1 === "Received" && item.status2 === "No support"))) {
                    createSSTBtn.classList.remove('hidden');
                }
            }

            const fixedContainer = document.getElementById('dolly-info-fixed');
            const scrollableContainer = document.getElementById('dolly-details-scrollable');
            fixedContainer.innerHTML = '';
            scrollableContainer.innerHTML = '';

            let verticalLineColor = '';
            if (Array.isArray(deliveryNote.status) && deliveryNote.status.some(s => s.includes('missing'))) verticalLineColor = 'bg-red-600';
            else if (deliveryNote.delivery_note === "No order") verticalLineColor = 'bg-orange-600';
            else if (deliveryNote.status === 'Treated') verticalLineColor = 'bg-green-600';
            else verticalLineColor = 'bg-gray-300';

            let statusHtml = '';
            if (deliveryNote.status === "Treated") statusHtml = `<p class="text-xs font-medium text-green-600">Treated</p>`;
            else if (deliveryNote.status === "Not treated" || (Array.isArray(deliveryNote.status) && deliveryNote.status.includes('Not treated'))) statusHtml = `<p class="text-xs font-medium text-gray-500">Not treated</p>`;
            
            let detailsContentHtml = `
                <div class="flex bg-[#f8f8ff] rounded-xl shadow-md">
                    <div class="w-2 rounded-l-xl ${verticalLineColor}"></div>
                    <div class="flex flex-col flex-grow">
                        <div class="flex justify-between items-center p-4 pb-0">
                            <p class="font-bold text-lg text-gray-900">${deliveryNote.delivery_note}</p>
                            <div class="flex items-baseline space-x-1"><span class="text-lg font-bold text-gray-900">${deliveryNote.total_count}</span></div>
                        </div>
                        <div class="flex justify-between items-center mt-1 px-4"><p class="text-xs text-gray-500">${deliveryNote.date_time}</p>${statusHtml}</div>
                        <div class="flex justify-between items-center mt-1 px-4"><p class="text-xs font-semibold text-gray-500">${deliveryNote.data_warehouse}</p></div>`;
            
            if (deliveryNote.delivery_note === "No order") {
                let warningText = deliveryNote.data_warehouse === "Dist. Center 150" ? "Not linked to the store" : "Received, no support";
                detailsContentHtml += `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-md mt-2 p-2 flex items-center space-x-2 text-xs"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.32a.75.75 0 011.486 0L14.73 13.5a.75.75 0 01-.663 1.15H5.933a.75.75 0 01-.663-1.15L8.257 3.32zM10 17a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg><p>${warningText}</p></div>`;
            } else {
                detailsContentHtml += `<div class="w-[90%] mx-auto mt-4 mb-0"><hr class="border-dotted border-gray-400"></div><div class="grid grid-cols-3 text-center mb-4 mt-1"><div class="flex flex-col items-center p-0 pt-2 mx-1"><p class="text-green-600 font-bold text-xl">${deliveryNote.received_count}</p><p class="text-gray-500 text-xs">Received</p></div><div class="flex flex-col items-center p-0 pt-2 mx-1"><p class="text-red-600 font-bold text-xl">${deliveryNote.not_delivered}</p><p class="text-gray-500 text-xs">Not delivered</p></div><div class="flex flex-col items-center p-0 pt-2 mx-1"><p class="text-orange-500 font-bold text-xl">${deliveryNote.not_scanned}</p><p class="text-gray-500 text-xs">Not scanned</p></div></div>`;
            }
            detailsContentHtml += `</div></div>`;
            fixedContainer.innerHTML = detailsContentHtml;

            const supportNumbers = supportNumbersByNote[dollyId] || [];
            let supportNumbersHtml = '<ul class="space-y-3 pt-4">';
            supportNumbers.forEach(item => {
                supportNumbersHtml += `<li class="flex bg-white rounded-xl shadow-md cursor-pointer" onclick='showUpdatePanel(${JSON.stringify(item)})'><div class="w-2 rounded-l-xl ${item.lineColor}"></div><div class="p-3 flex flex-col flex-grow"><p class="font-bold text-md text-gray-900">${item.number}</p><p class="text-xs text-gray-500">${item.subtitle}</p></div><div class="p-3 flex flex-col items-end justify-center text-right"><p class="font-bold text-sm ${item.status1Color}">${item.status1}</p>${item.status2 ? `<p class="text-xs text-gray-500">${item.status2}</p>` : ''}</div></li>`;
            });
            supportNumbersHtml += '</ul>';
            scrollableContainer.innerHTML = supportNumbersHtml;
        }

        function addManually() {
            const randomSSCC = document.getElementById('support-number-input').value;
            let notificationMessage, targetNote, highlightClass, newValue;
            manualAddCounter++;

            if (manualAddCounter % 2 !== 0) {
                notificationMessage = "Support not linked to the store. Entry created requires treatment";
            } else {
                targetNote = deliveryNotes.find(note => note.delivery_note === "1559145574");
                notificationMessage = `Manually entered. Delivery note: ${targetNote.delivery_note}`;
            }
            updateNotification(randomSSCC, notificationMessage);
            closeOpenPopups();

            if (manualAddCounter % 2 !== 0) {
                const now = new Date();
                const formattedDate = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${now.getFullYear()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                targetNote = { "id": Date.now(), "delivery_note": "No order", "date_time": formattedDate, "data_warehouse": "Dist. Center 150", "received_count": 1, "total_count": 1, "status": "Not treated", "not_scanned": null, "not_delivered": null };
                deliveryNotes.unshift(targetNote);
                initializeSupportNumbers(targetNote);
                renderDeliveryList();
                highlightClass = 'highlight-new-record';
            } else {
                targetNote = deliveryNotes.find(note => note.delivery_note === "1559145574");
                if (!targetNote) return;
                targetNote.received_count = 3;
                targetNote.status = "Treated";
                highlightClass = 'highlight-record';
            }

            const targetRecordEl = document.getElementById(`note-${targetNote.id}`);
            if (!targetRecordEl) return;
            const recordDiv = targetRecordEl.querySelector('div');
            targetRecordEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => {
                if (recordDiv) recordDiv.classList.add(highlightClass);
                if (targetNote.delivery_note !== "No order") {
                    const countSpan = document.getElementById('count-' + targetNote.id);
                    if (countSpan) {
                        countSpan.classList.add('highlight-count-scale');
                        setTimeout(() => {
                            countSpan.textContent = targetNote.received_count;
                            setTimeout(() => {
                                countSpan.classList.remove('highlight-count-scale');
                                renderDeliveryList();
                                if (recordDiv) recordDiv.classList.remove(highlightClass);
                            }, 500);
                        }, 200);
                    }
                } else {
                    setTimeout(() => { if (recordDiv) recordDiv.classList.remove(highlightClass); }, 1000);
                }
            }, 500);
        }
        
        // --- Popup & Panel Management ---
        function showManualAddPopover(event) {
            // Screen guard to prevent this from opening on the wrong screen
            if (currentScreen !== 1) return;
            event.stopPropagation();
            const popover = document.getElementById('manual-add-popover');
            const inputEl = document.getElementById('support-number-input');
            const overlay = document.getElementById('global-overlay');
            inputEl.value = '';
            updateManualAddUI();
            popover.style.display = 'flex';
            overlay.style.display = 'block';
            setTimeout(() => { if (inputEl) inputEl.focus(); }, 100);
        }

        function updateManualAddUI() {
            const inputEl = document.getElementById('support-number-input');
            const addButton = document.getElementById('add-button');
            const counterEl = document.getElementById('digit-counter');
            const inputValue = inputEl.value;
            counterEl.textContent = `${inputValue.length} / 18`;
            addButton.disabled = inputValue.length !== 18;
            addButton.classList.toggle('opacity-50', inputValue.length !== 18);
            addButton.classList.toggle('cursor-not-allowed', inputValue.length !== 18);
        }
        
        function showUpdatePanel(item) {
            if (currentScreen !== 2) return;
            currentSelectedItem = item;
            
            const { status1, status2 } = item;

            // Get references to UI elements
            const btnReceivedManual = document.getElementById('btn-received-manual');
            const btnReceivedNoSupport = document.getElementById('btn-received-no-support');
            const btnNotDelivered = document.getElementById('btn-not-delivered');
            const btnNotScanned = document.getElementById('btn-not-scanned');
            const updateStatusSection = document.getElementById('update-status-section');

            // Reset visibility by default
            btnReceivedManual.classList.add('hidden');
            btnReceivedNoSupport.classList.add('hidden');
            btnNotDelivered.classList.add('hidden');
            btnNotScanned.classList.add('hidden');

            let isAnyButtonVisible = false;

            // Apply visibility rules
            if (status1 === 'Not scanned' || status1 === 'Not delivered') {
                btnReceivedManual.classList.remove('hidden');
                isAnyButtonVisible = true;
            }
            if (status1 === 'Not scanned' || status1 === 'Not delivered' || (status1 === 'Received' && status2 === 'Manual')) {
                btnReceivedNoSupport.classList.remove('hidden');
                isAnyButtonVisible = true;
            }
            if (status1 === 'Not scanned' || (status1 === 'Received' && status2 === 'Manual')) {
                btnNotDelivered.classList.remove('hidden');
                isAnyButtonVisible = true;
            }
            if (status1 === 'Not delivered' || (status1 === 'Received' && status2 === 'Manual')) {
                btnNotScanned.classList.remove('hidden');
                isAnyButtonVisible = true;
            }

            // Show/Hide the whole section based on button visibility
            updateStatusSection.classList.toggle('hidden', !isAnyButtonVisible);

            // Populate header
            document.getElementById('panel-support-number').textContent = item.number.replace(/(\d{4})/g, '$1 ').trim();
            document.getElementById('panel-support-subtitle').textContent = item.subtitle;
            const status1El = document.getElementById('panel-support-status1');
            status1El.textContent = item.status1;
            document.getElementById('panel-support-status2').textContent = item.status2 || '';
            status1El.className = 'font-bold text-sm'; // Reset classes
            if (item.status1Color) status1El.classList.add(...item.status1Color.split(' '));
            
            // Show panel and overlay
            const panel = document.getElementById('update-status-panel');
            const overlay = document.getElementById('screen-2-overlay');
            overlay.style.display = 'block';
            panel.classList.add('visible');
        }
        
        function updateItemStatus(newStatus) {
            if (!currentSelectedItem || !activeDollyId) return;
            const supportList = supportNumbersByNote[activeDollyId];
            const itemToUpdate = supportList.find(i => i.number === currentSelectedItem.number);

            if (itemToUpdate) {
                switch (newStatus) {
                    case 'Received (Manual)':
                        itemToUpdate.status1 = "Received"; itemToUpdate.status2 = "Manual";
                        itemToUpdate.lineColor = 'bg-green-600'; itemToUpdate.status1Color = 'text-green-600';
                        break;
                    case 'Received (No support)':
                        itemToUpdate.status1 = "Received"; itemToUpdate.status2 = "No support";
                        itemToUpdate.lineColor = 'bg-orange-600'; itemToUpdate.status1Color = 'text-orange-600';
                        break;
                    case 'Not delivered':
                        itemToUpdate.status1 = "Not delivered"; itemToUpdate.status2 = "";
                        itemToUpdate.lineColor = 'bg-red-600'; itemToUpdate.status1Color = 'text-red-600';
                        break;
                    case 'Not scanned':
                        itemToUpdate.status1 = "Not scanned"; itemToUpdate.status2 = "";
                        itemToUpdate.lineColor = 'bg-gray-300'; itemToUpdate.status1Color = 'text-gray-500';
                        break;
                }
            }
            closeOpenPopups();
            showDollyDetails(activeDollyId);
        }

        function showSupportDetails() {
            if (!currentSelectedItem || !activeDollyId) return;
            const deliveryNote = deliveryNotes.find(note => note.id === activeDollyId);
            if (!deliveryNote) return;

            const fixedContainer = document.getElementById('support-info-fixed');
            const item = currentSelectedItem;
            
            const newHeaderHtml = `
                <div class="flex bg-white rounded-xl shadow-md items-stretch">
                    <!-- Gray Status Line -->
                    <div class="w-2 bg-gray-300 rounded-l-xl"></div>
                    
                    <div class="flex-1 p-4">
                        <p class="font-bold text-lg text-gray-900">${deliveryNote.delivery_note}</p>
                        <p class="text-xs text-gray-500 mt-1">${deliveryNote.date_time}</p>
                        <p class="text-xs font-semibold text-gray-500 mt-1">${deliveryNote.data_warehouse}</p>
                    </div>
                    
                    <!-- Vertical Divider -->
                    <div class="w-px bg-gray-200 my-4"></div>
                    
                    <div class="flex-1 p-4 text-right">
                        <p class="font-bold text-green-800 text-base mt-1">${item.number}</p>
                        <p class="text-xs text-gray-500 mt-1">${item.subtitle}</p>
                    </div>
                </div>
            `;
            
            fixedContainer.innerHTML = newHeaderHtml;
            
            renderSupportDetailsTable(item.number);

            // Correct order: First navigate, then close popups.
            showScreen(3);
            closeOpenPopups();
        }

        function closeOpenPopups() {
            document.getElementById('global-overlay').style.display = 'none';
            document.getElementById('screen-2-overlay').style.display = 'none';
            document.getElementById('manual-add-popover').style.display = 'none';
            document.getElementById('update-status-panel').classList.remove('visible');
            if (currentScreen !== 3) {
                 currentSelectedItem = null;
            }
        }

        // --- Data Initialization ---
        function initializeSupportNumbers(singleNote = null) {
            const notesToProcess = singleNote ? [singleNote] : deliveryNotes;
            const subtitles = ["MP / Box", "Dolly / Rolltainers", "Display"];

            const productDescriptions = [ "Organic Bananas", "Whole Milk Gallon", "Free-Range Eggs (Dozen)", "Sourdough Bread Loaf", "Avocado Hass", "Cherry Tomatoes Pint", "Greek Yogurt 32oz", "Almond Butter Jar", "Quinoa 1lb Bag", "Spinach Bunch", "Chicken Breast 1lb", "Salmon Fillet", "Olive Oil 500ml", "Balsamic Vinegar", "Sea Salt Grinder", "Black Peppercorns", "Garlic Head", "Yellow Onion", "Red Bell Pepper", "Cucumber", "Lemon", "Lime", "Canned Chickpeas", "Black Beans Can", "Pasta Fusilli 1lb" ];

            notesToProcess.forEach(note => {
                let supportNumbers = [];
                // Specific, hardcoded logic for the prototype's test data
                if (note.delivery_note === "1559141952") {
                    const statuses = [ { status1: "Received", status2: "Scanned", subtitle: "Dolly/Rolltainers", lineColor: 'bg-green-600', status1Color: 'text-green-600' }, { status1: "Received", status2: "Scanned", subtitle: "Dolly/Rolltainers", lineColor: 'bg-green-600', status1Color: 'text-green-600' }, { status1: "Received", status2: "Scanned", subtitle: "Dolly/Rolltainers", lineColor: 'bg-green-600', status1Color: 'text-green-600' }, { status1: "Not delivered", status2: "", subtitle: "MP / Box", lineColor: 'bg-red-600', status1Color: 'text-red-600' }, { status1: "Not scanned", status2: "", subtitle: "Display", lineColor: 'bg-gray-300', status1Color: 'text-gray-500' } ];
                    supportNumbers = statuses.map(status => ({ ...status, number: generateRandom18DigitNumber() }));
                } else if (note.delivery_note === "No order") {
                    supportNumbers.push({ number: generateRandom18DigitNumber(), subtitle: subtitles[Math.floor(Math.random() * subtitles.length)], status1: "Received", status2: "No support", lineColor: 'bg-orange-600', status1Color: 'text-orange-600' });
                } else {
                    // Generic data generation based on parent note's KPIs
                    for (let i = 0; i < note.total_count; i++) {
                        let status1 = "Received", status2 = "Scanned", lineColor = 'bg-green-600', status1Color = 'text-green-600';
                        const notScannedCount = note.not_scanned || 0;
                        const notDeliveredCount = note.not_delivered || 0;
                        if (i < notScannedCount) { status1 = "Not scanned"; status2 = ""; lineColor = 'bg-gray-300'; status1Color = 'text-gray-500'; }
                        else if (i < notScannedCount + notDeliveredCount) { status1 = "Not delivered"; status2 = ""; lineColor = 'bg-red-600'; status1Color = 'text-red-600'; }
                        supportNumbers.push({ number: generateRandom18DigitNumber(), subtitle: subtitles[i % 3], status1, status2, lineColor, status1Color });
                    }
                }
                const shuffledNumbers = shuffleArray(supportNumbers);
                supportNumbersByNote[note.id] = shuffledNumbers;

                // NEW: Generate details for each support number
                shuffledNumbers.forEach((support, index) => {
                    if (!supportDetailsByNumber[support.number]) {
                        supportDetailsByNumber[support.number] = [];
                        // Some have many items, some have few
                        const itemCount = (index % 4 === 0) ? 30 + Math.floor(Math.random() * 10) : 5 + Math.floor(Math.random() * 5);
                        for (let i = 0; i < itemCount; i++) {
                            supportDetailsByNumber[support.number].push({
                                hope: Math.floor(100000 + Math.random() * 900000),
                                description: productDescriptions[Math.floor(Math.random() * productDescriptions.length)],
                                qty: Math.floor(Math.random() * 99) + 1,
                                colli: Math.floor(Math.random() * 99) + 1
                            });
                        }
                    }
                });
            });

             // This logic runs only on the initial full load to adjust statuses
            if (!singleNote) {
                const allReceivedItems = [];
                for (const noteId in supportNumbersByNote) {
                    supportNumbersByNote[noteId].forEach(item => {
                        if (item.status1 === 'Received') {
                            allReceivedItems.push(item);
                        }
                    });
                }

                shuffleArray(allReceivedItems); // Randomize the list
                const itemsToChangeCount = Math.floor(allReceivedItems.length * 0.2);

                allReceivedItems.forEach((item, index) => {
                    if (index < itemsToChangeCount) {
                        item.status2 = 'Manual';
                    } else {
                        item.status2 = 'Scanned';
                    }
                });
            }
        }
        
        // --- Table Rendering and Sorting ---
        function renderSupportDetailsTable(supportNumber) {
            const tableBody = document.querySelector("#support-details-table tbody");
            if (!tableBody) return;

            let details = supportDetailsByNumber[supportNumber] || [];

            // Sorting logic
            details.sort((a, b) => {
                const aVal = a[sortState.key];
                const bVal = b[sortState.key];
                if (aVal < bVal) return sortState.order === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortState.order === 'asc' ? 1 : -1;
                return 0;
            });

            // Update sort icons
            const sortIconNeutral = `<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg>`;
            const sortIconAsc = `<svg class="w-4 h-4 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>`;
            const sortIconDesc = `<svg class="w-4 h-4 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
            
            document.getElementById('sort-icon-description').innerHTML = sortState.key === 'description' ? (sortState.order === 'asc' ? sortIconAsc : sortIconDesc) : sortIconNeutral;
            document.getElementById('sort-icon-qty').innerHTML = sortState.key === 'qty' ? (sortState.order === 'asc' ? sortIconAsc : sortIconDesc) : sortIconNeutral;
            document.getElementById('sort-icon-colli').innerHTML = sortState.key === 'colli' ? (sortState.order === 'asc' ? sortIconAsc : sortIconDesc) : sortIconNeutral;


            tableBody.innerHTML = details.map(item => `
                <tr class="border-b bg-white">
                    <td class="py-4 px-2 align-top w-2/3">
                        <p class="font-semibold text-gray-800">${item.hope}</p>
                        <p class="text-gray-600">${item.description}</p>
                    </td>
                    <td class="py-4 px-2 text-center align-middle font-medium text-darkslateblue">${item.qty}</td>
                    <td class="py-4 px-2 text-right align-middle font-bold text-darkblue">${item.colli}</td>
                </tr>
            `).join('');
        }

        function sortDetailsTable(key) {
            if (!currentSelectedItem) return; // Guard clause for the error
            if (sortState.key === key) {
                sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.key = key;
                sortState.order = 'asc';
            }
            renderSupportDetailsTable(currentSelectedItem.number);
        }

        // --- App Start ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeSupportNumbers(); 
            renderDeliveryList();
            showScreen(1);

            // Ensure all popups are in a known hidden state on start
            closeOpenPopups();

            const today = new Date();
            document.getElementById('today-date').textContent = formatDate(today);

            const inputEl = document.getElementById('support-number-input');
            inputEl.addEventListener('input', () => {
                inputEl.value = inputEl.value.replace(/\D/g, '');
                updateManualAddUI();
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === "ArrowLeft") {
                    goBack();
                }
            });
        });
    </script>

</body>
</html>

